<head>
<style>
.chat{
    position:absolute !important;
    width: 50%;
    height: 50%;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    margin-left: 4px;
}

.chat .msgs{
    overflow-y:scroll;
    width:100%;
    height:90%;
}
#chatinput{
    resize: vertical;
    width: 99%;
    height: 9%;
    bottom: 0px;
    font-family: 'Lucida Console';
    font-size: 14px;
    margin-left: 4px;
    position: absolute !important;
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:;
}
.onlineusers{
	top: 0px;
    right: 17px;
    position: absolute !important;
    background-color: white;
}
</style>
</head>
<body>
	<div id="chat" class="chat"">
	    <div class="msgs">
	        <div><b>Welcome to the proper lunch chat channel.</b></br></div>
	        <div>github for this app: <a href ="https://github.com/simon-kyger/chat" target="_blank">https://github.com/simon-kyger/chat</a></br></div>
	        <div><i>Command List:</i></br></div>
	        <div>&nbsp &nbsp <b>/name</b> <i>name</i>  :: gives you a name for current session. 20 char limit</br></div>
	        <div>&nbsp &nbsp <b>/color</b> <i>color</i>  :: changes color of your socket msgs</br></div>
	        <div>&nbsp &nbsp <b>/theme</b> dark  :: changes theme to dark (only one atm)</br></div>
	        <div>&nbsp &nbsp <b>/gif</b> <i>searchterm</i>  :: searches giphy for a gif based upon searchterm</br></div>
	    </div>
	    <input id="chatinput" class="chatinput"></input>
	    <div id="chatresizer" class="resizer ui-resizable-handl ui-resizable-ne"></div>
		<div id="onlineusers" class="onlineusers"></div>
	</div>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    var socket = io();
    var chat = $('.chat');
    var onlineusers = $('.onlineusers');
    chat.posts = [];
    chat.position = 0;
    chat.printer = $('.msgs', chat);
    chat.chatinput = $('.chatinput', chat);
    chat.height = chat.printer.height();
    chat.preventNewScroll = false;
    chat.scrollBottom = function() {
        if (!chat.preventNewScroll) { // if mouse is not over printer
            chat.printer.stop().animate({ 
            	scrollTop: chat.printer[0].scrollHeight - chat.printer.height()
            }, 600); // SET SCROLLER TO BOTTOM
        }
    }
    chat.scrollBottom();
    chat.postmsg = function(e) {
        //down
        if (e.which == 40){
        	chat.position--;
    		if (chat.position < 0)
    			chat.position = -1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        //up
        if (e.which == 38){
        	chat.position++;
        	if (chat.position > chat.posts.length)
    			chat.position = chat.posts.length-1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }

        //enter
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            var msg = chat.chatinput.val(); 
            
            if ($.trim(msg)) {
                socket.emit('chatMsg', msg);
                chat.posts.push(msg);
                chat.position = chat.posts.length;
                chat.chatinput[0].value = ''; // CLEAR TEXTAREA
                chat.scrollBottom();
            }
        }
    }
    chat.chatinput.keyup(chat.postmsg);
    // prevent scrolling when reading past msgs
    chat.printer.hover(function (e) {
        chat.preventNewScroll = e.type === 'mouseenter';
        if (!chat.preventNewScroll) { chat.scrollBottom(); } // On mouseleave go to bottom
    });
    chat.resizable({
        handles: {
            'ne': '#chatresizer'
        }
    });
    chat.draggable({
        containment: "body"
    });

    //net
    socket.on('addToChat', function (data) {
        chat.printer.append(
			'<div style ="color:'+data.color+'">'
			+ data.date + ' ' + '<b>'
			+ data.name + ': ' + '</b>'
			+ data.msg.replace(/\n/g, '<br>') + '</div>');
        chat.scrollBottom();
    });
    socket.on('updateUsers', function (data){
    	onlineusers.empty();
    	onlineusers.append('<div>Online Users: &nbsp</div>');
    	for (var i=0; i<data.length; i++){
			if (isNaN(data[i]))
				data[i] = data[i].replace(/\n/g, '<br>');
			onlineusers.append('<div style ="color:'+data[i].color+'">' + data[i] + '</div>');
    	}
    });

    socket.on('changeInputFontColor', function (data){
    	chat.chatinput.css("color", data);
    });

    socket.on('changeTheme', function (data){
    	data = data.trim();
    	if (data == 'dark'){
			$('body').css("background-color", "rgb(70,70,70)");
			chat.chatinput.css("background-color", "rgb(50,50,50)");
			onlineusers.css("background-color", "rgb(70,70,70)");
    	}
    	else{
			$(document.body).css("background-color", "rgb(255,255,255)");
			chat.chatinput.css("background-color", "rgb(255,255,255)");
			onlineusers.css("background-color", "rgb(255,255,255)");
    	}
    });
</script>