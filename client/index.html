<head>
<style>
body{
    margin: 0px;
}
.chat{
    position:absolute !important;
    width: 50%;
    height: 50%;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    box-shadow: 10px 10px 5px #888888;
}

.chat .msgs{
    overflow-y:scroll;
    width:100%;
    height:90%;
}
#chatinput{
    resize: vertical;
    width: 100%;
    height: 10%;
    bottom: 0px;
    font-family: 'Lucida Console';
    font-size: 14px;
    position: absolute !important;
    white-space: pre-wrap;
    resize: none;
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:9999;
}
.onlineusers{
    top: 0px;
    right: 17px;
    position: absolute !important;
    box-shadow: 0px 0px 20px #888888;
}
.cfg{
    position: absolute !important;
    bottom: 8px;
    right: 8px;
    font-weight: bold;
    font-size: 28px;
    color: silver;
    z-index:999;
}
.config{
    position: absolute !important;
    bottom: 0px;
    right: 0px;
    font-size: 14px;
    width: 0%;
    height: 0%;
    opacity: 0;
    border-color: rgb(169, 169, 169);
    font-family: monospace;
    border-style: solid;
    border-width: 1px;
    background-color: lightgray;
}
.redshadow{
    text-shadow: 2px 2px 8px #FF0000;
    font-weight: bold;
}
</style>
</head>
<body>
    <div id="chat" class="chat"">
        <div class="msgs">
            <div class="redshadow">Welcome to the proper lunch chat channel!</br></div>
            <div>&nbsp; &nbsp; github --> <a href ="https://github.com/simon-kyger/chat" target="_blank">https://github.com/simon-kyger/chat</a></br></div>
            <div>&nbsp; &nbsp; <i>Commandlist: /? or /help</i></br></div>
        </div>
        <textarea id="chatinput" class="chatinput" placeholder="Chat here! or /? for a list of commands." autofocus="autofocus"></textarea>
        <div id="chatresizer" class="resizer ui-resizable-handl ui-resizable-ne"></div>
        <div id="onlineusers" class="onlineusers"></div>
        <div id="cfg" class="cfg">&#x2699;</div>
        <div id="config" class="config">
            <input id="videotoggle" class="videotoggle" type="checkbox">Hide Videos<br>
            <input id="imagetoggle" class="imagetoggle" type="checkbox">Hide Images
        </div>
    </div>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>
//globals
    let socket = io();
    let chat = $('.chat');
    let onlineusers = $('.onlineusers');
    chat.posts = [];
    chat.position = 0;
    chat.printer = $('.msgs', chat);
    chat.chatinput = $('.chatinput', chat);
    chat.cfg = $('.cfg');
    chat.cfg.videostoggle = $('.videotoggle');
    chat.cfg.imagestoggle = $('.imagetoggle');
    
//events
    chat.resizable({
        handles: {
            'ne': '#chatresizer'
        }
    });
    chat.draggable({
        containment: "body"
    });
    chat.scrollBottom = function() {
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 1000); // SET SCROLLER TO BOTTOM
    }
    chat.scrollBottom();
    chat.postmsg = function(e) {
        //down
        if (e.which == 40){
            chat.position--;
            if (chat.position < 0)
                chat.position = -1;
            chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        //up
        if (e.which == 38){
            chat.position++;
            if (chat.position > chat.posts.length)
                chat.position = chat.posts.length-1;
            chat.chatinput[0].value = chat.posts[chat.position] || '';
        }

        //enter
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            var msg = chat.chatinput.val().trim(); 
            socket.emit('chatMsg', msg);
            chat.posts.push(msg);
            chat.position = chat.posts.length;
            chat.chatinput[0].value = ''; // CLEAR TEXTAREA
            chat.scrollBottom();
        }
    }
    chat.chatinput.keyup(chat.postmsg);


    chat.cfg.expanded = true;
    chat.cfg.expand = function(){
        if (chat.cfg.expanded){
            $("#config").animate({
                width: "0%",
                height: "0%",
                opacity: 0,
                fontSize: "0",
                borderWidth: "0px"
            }, 500 );
            chat.cfg.expanded = false;
        } else {
            $( "#config" ).animate({
                width: "20%",
                height: "30%",
                opacity: 0.8,
                fontSize: "14",
                borderWidth: "6px"
            }, 500 );
            chat.cfg.expanded = true;
        }
    }
    chat.cfg.click(chat.cfg.expand);
    chat.cfg.click();

    chat.cfg.videostoggle.on('change', function(){
        chat.cfg.videostoggle ? $('.iframe').hide() : $('.iframe').show();
        chat.cfg.videostoggle = !chat.cfg.videostoggle;
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 0); 
    });
    chat.cfg.imagestoggle.on('change', function(){
        chat.cfg.imagestoggle ? $('.imgs').hide() : $('.imgs').show();
        chat.cfg.imagestoggle = !chat.cfg.imagestoggle;
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 0); 
    });

//net
    //data expects data.chatmessages[].properties
    socket.on('addToChat', function (data) {
        var shouldscroll = chat.printer.scrollTop() >= (chat.printer[0].scrollHeight - document.getElementsByClassName('msgs')[0].offsetHeight);
        var renderobj = new RenderingObject();
        for (let i=0; i<data.chatmessages.length; i++){
            //evil dragons be here
            renderobj[data.chatmessages[i].action](data.chatmessages[i]);
        }
        if (shouldscroll)
            chat.scrollBottom();
    });

    //data expects array
    socket.on('updateUsers', function (data){
        onlineusers.empty();
        onlineusers.append('<div class="redshadow">Online Users: &nbsp</div>');
        for (var i=0; i<data.length; i++){
            if (isNaN(data[i]))
                data[i] = data[i].replace(/\n/g, '<br>');
            onlineusers.append(`<div style="color:${data[i].color}">${data[i]}</div>`);
        }
    });

    //data expects string
    socket.on('changeInputFontColor', function (data){
        chat.chatinput.css("color", data);
    });

    //data expects string
    socket.on('changeTheme', function (data){
        data = data.trim();
        if (data == 'dark'){
            $('body').css("background-color", "rgb(70,70,70)");
            chat.chatinput.css("background-color", "rgb(50,50,50)");
            onlineusers.css("background-color", "rgb(70,70,70)");
        }
        else{
            $(document.body).css("background-color", "rgb(255,255,255)");
            chat.chatinput.css("background-color", "rgb(255,255,255)");
            onlineusers.css("background-color", "rgb(255,255,255)");
        }
    });

    
    var RenderingObject = function() {
        this.renderText = function(args) {
            let div = `<div style="color:${args.color}; background-color:${args.bgcolor}; text-shadow: ${args.textshadow};">${args.date}<b> ${args.name} </b>${args.msg}</div>`;
            chat.printer.append(div);
        },
        this.renderImage = function(args) {
            let img = `<a href="${args.msg}" target="_blank"><img class="imgs" src="${args.msg}" target="_blank" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img></a>`;
            let link = `<a href="${args.msg}" target="_blank">${args.msg}</a>`;
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} </b>${link}<br>${img}</div>`
            chat.printer.append(div);
            chat.cfg.imagestoggle ? $('.imgs').show() : $('.imgs').hide();
            //lolfun $('.imgs').draggable({containment: $('.msgs')});
        }
        this.renderStaticImage = function(args) {
            let img = `<img class="imgs" src="data:image/png;base64,${args.image}" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img>`;
            let div = `<div style ="color:${args.color};">${args.date}<b> ${args.name} </b>${img} </div>`
            chat.printer.append(div);
            chat.cfg.imagestoggle ? $('.imgs').show() : $('.imgs').hide();
        }
        this.renderCodeBlock = function(args){
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} CODEBLOCK:</b> 
                      </div><pre style="white-space: pre-wrap;"><code class="code" style="border-radius: 10px;">${args.msg.replace(/\n/g, '<br>')} </code></pre>`;
            chat.printer.append(div);
            $('.code').each(function(i, block) {
              hljs.highlightBlock(block);
            });
        }
        this.renderVideo = function(args){
            let url = `https://www.youtube.com/embed/${args.msg}`;
            let link = `<a href="${url}">${url}</a>`;
            let iframe = `<iframe class="iframe" style="height: 300px; width: 500px" src="//www.youtube.com/embed/${args.msg}" allowfullscreen></iframe>`; 
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} </b>${link}<br>${iframe}</div>`; 
            chat.printer.append(div);
            chat.cfg.videostoggle ? $('.iframe').show() : $('.iframe').hide();
        }
    };
</script>