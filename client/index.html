<head>
<style>
body{
    margin: 0px;
}
.chat{
    position:absolute !important;
    width: 55%;
    height: 55%;
    opacity: 1;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    box-shadow: 0px 0px 1px 1px #888888;
}
.chat .msgs{
    overflow-y:scroll;
    width:80%;
    height:80%;
}
.inputcontainer{
    width: 100%;
    height: 15%;
    font-family: 'Lucida Console';
    font-size: 14px;
    position: absolute !important;
    white-space: pre-wrap;
    resize: none;
    color: white;
    bottom: 0%;
}
.istyping{
    position:absolute;
    top: 0%;
    //width: -webkit-calc(100% - 15px);
    width: 80%;
    height: 30%;
    line-height: 1.3;
}
.inputcontainer .chatinput{
    position: absolute;
    top: 30%;
    width: 100%;
    height: 70%;
    left: 0;
    resize: none;
    overflow: hidden;
    border: 1px solid black;
}
.inputcontainer .cfg{
    z-index: 999;
    position: absolute;
    right: 2%;
    font-size: 32px;
    bottom: 10%;
    cursor: pointer;
    -webkit-text-size-adjust:none;
}
.config{
    position: absolute !important;
    bottom: 0px;
    right: 0px;
    font-size: 14px;
    width: 0%;
    height: 0%;
    opacity: 0;
    border-color: rgb(0, 0, 0);
    font-family: monospace;
    border-style: solid;
    border-width: 2px;
    background-color: rgb(200, 200, 200);
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:2;
    cursor: nesw-resize;
}
.onlineusers{
    z-index: 1;
    top: 0px;
    right: 0px;
    position: absolute;
    opacity: 0;
    border-bottom: 1px solid;
    border-color: black; 
    width: 20%;
}
.redshadow{
    text-shadow: 2px 2px 8px #FF0000;
    font-weight: bold;
}
.cgroup{
    width:80%;
    height:5%;
    border-bottom: 1px solid;
    border-right: 1px solid;
    display: inline-block;
    overflow: hidden;
}
.tab{
    border: 1px solid black;
    cursor: pointer;
    width: 10%;
    float:left;
    height:100%;
}
.closerX{
    width: 15px;
    height: 15px;
    display:inline-block;
    color: white;
    background-color: black;
    text-align: -webkit-center;
    float: right;
}

</style>
</head>
<body>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="//cdn.jsdelivr.net/jquery.shadow-animation/1/mainfile"></script>
<script>
//globals
    let socket = io();
    var builder = function(){
        var self = this;
        this.chat = $(`<div id='chat' class='chat'>`);
        this.chat.appendTo($('body'));
        this.inputcontainer = $(`<div id='inputcontainer' class='inputcontainer'>`);
        this.inputcontainer.appendTo(this.chat);
        this.cgroup = $(`<div id='cgroup' class='cgroup'>`);
        this.cgroup.appendTo(this.chat);
        this.msgs = $(`<div id='msgs' class='msgs'>`);
        this.msgs.appendTo(this.chat);
        this.config = $(`<div id='config' class='config'>`);
        this.config.appendTo(this.chat);
        this.chatresizer = $(`<div id='chatresizer' class='resizer ui-resizable-handl ui-resizable-ne'>`);
        this.chatresizer.appendTo(this.chat);
        this.videotoggle = $(`<input id='videotoggle' class='videotoggle' type='checkbox'>Hide Videos<br>`);
        this.videotoggle.appendTo(this.config);
        this.imagetoggle = $(`<input id='imagetoggle' class='imagetoggle' type='checkbox'>Hide Images</input>`);
        this.imagetoggle.appendTo(this.config);
        this.cfg = $(`<div id='cfg' class='cfg'>&#x2699;</div>`);
        this.cfg.appendTo(this.inputcontainer);
        this.textarea = $(`<textarea id='chatinput' class='chatinput' placeholder='Chat here! or /? for a list of commands.' autofocus='autofocus'></textarea>`);
        this.textarea.appendTo(this.inputcontainer);
        this.istyping = $(`<div class='istyping'></div>`);
        this.istyping.appendTo(this.inputcontainer);
        this.welcome = $(`<div class='redshadow'>Welcome to the proper lunch chat channel!</br></div>`);
        this.welcome.appendTo(this.msgs);
        this.githublink = $(`<div>&nbsp; &nbsp; github --> <a href='https://github.com/simon-kyger/chat' target='_blank'>https://github.com/simon-kyger/chat</a></br></div>`)
        this.githublink.appendTo(this.msgs);
        this.commandlist = $(`<div>&nbsp; &nbsp; <i>Commandlist: /? or /help</i></br></div>`);
        this.commandlist.appendTo(this.msgs);
        this.onlineusers = $(`<div id='onlineusers' class='onlineusers'></div>`); 
        this.onlineusers.appendTo(this.chat);
        this.maincgroup = $(`<div id='maincgroup' class='tab' style='width: 10%;'>Main</div>`);
        this.maincgroup.appendTo(this.cgroup);
        this.prevmsgs = {};
        this.curtab = 'Main';
        //args.curtab = 'main' args.id = id of thing clicked
        this.newtab = function(args){
            if(args.curtab == 'Main')
                return;
            self.tab = $(`<div id='tab${args.curtab}' class='tab'>${args.curtab}</div>`);
            self.tab.appendTo(self.cgroup);
            self.tabX = $(`<div id='tabX${args.curtab}' class='closerX'>X</div>`);
            self.tabX.appendTo(self.tab);
            self.tabX.on('click', function(){
                self.maincgroup.click();
                this.parentElement.remove();
            });
            self.tab.on('click', function(){
                self.curtab = this.innerText.slice(0, -1);
                self.msgs.empty();
                self.msgs.append(self.prevmsgs[self.curtab]);
            });
            self.curtab = this.tab[0].innerText.slice(0, -1);
            self.msgs.empty();
            self.msgs.append(self.prevmsgs[self.curtab]);
        }

        this.maincgroup.on('click', function(){
            self.curtab = 'Main';
            self.msgs.empty();
            self.msgs.append(self.prevmsgs['Main']);
        });

        this.chat.draggable({
            containment: 'body'
        });
        this.chat.resizable({
            handles: {
                'ne': this.chatresizer
            }
        });
        this.posts = [];
        this.position = 0;
        this.textarea.on('change keydown input paste', function(e){
            //down
            if (e.which == 40){
                self.position--;
                if (self.position < -1)
                    self.position = -1;
                this.value = self.posts[self.position] || '';
            }
            //up
            if (e.which == 38){
                self.position++;
                if (self.position > self.posts.length)
                    self.position = self.posts.length;
                this.value = self.posts[self.position] || '';
            }
            if (e.which == 13 && !e.shiftKey)
                e.preventDefault();
            //enter

            if (e.which == 13 && !e.shiftKey && this.value.trim().length>0) {
                e.preventDefault();
                let msg = this.value.trim(); 
                socket.emit('chatMsg', {msg: msg, curtab: self.curtab});
                self.posts.push(msg);
                self.position = self.posts.length;
                this.value = ''; // CLEAR TEXTAREA
                self.scrollBottom();
                socket.chatting = false;
            }
            //any other key
            if (this.value.length){
                socket.emit('istyping', 1);
            } else{
                socket.emit('istyping', 0);
            }
        });
        this.videotoggle.on('change', function() {
            self.videotoggle ? $('.iframe').hide() : $('.iframe').show();
            self.videotoggle = !self.videotoggle;
            self.msgs.stop().animate({ 
                scrollTop: self.msgs.scrollHeight
            }, 0); 
        });
        this.imagetoggle.on('change', function(){
            self.imagetoggle ? $('.imgs').hide() : $('.imgs').show();
            self.imagetoggle = !self.imagetoggle;
            self.msgs.stop().animate({ 
                scrollTop: self.msgs.scrollHeight
            }, 0); 
        });
        this.cfg.expanded = false;
        this.cfg.click(function(){
            if (self.cfg.expanded){
                self.config.animate({
                    width: '0%',
                    height: '0%',
                    opacity: 0,
                    fontSize: '0',
                    borderWidth: '20px'
                }, 500 );
                self.cfg.expanded = false;
            } else {
                self.config.animate({
                    width: '20%',
                    height: '30%',
                    opacity: 0.8,
                    fontSize: '14',
                    borderWidth: '2px'
                }, 500 );
                self.cfg.expanded = true;
            }
        });
    }
    let chat = new builder();
    builder.prototype.scrollBottom = function() {
        this.msgs.stop().animate({ 
            scrollTop: this.msgs[0].scrollHeight
        }, 1000); // SET SCROLLER TO BOTTOM
    }

    builder.prototype.getTheme = function(args) {
        let bgformatted;
        let shadow;
        let text;
        let cinput;
        if (args > 0)
            text = 'black'
        else
            text = 'white';

        let randomrgb = [((Math.floor(Math.random()*150)+55)+args), ((Math.floor(Math.random()*150)+55)+args), ((Math.floor(Math.random()*150)+55)+args)];
        let darker = [];
        let darkest = [];
        for(let i=0; i<randomrgb.length; i++){
            randomrgb[i] < 0 ? randomrgb[i] = 0 : randomrgb[i];
            randomrgb[i] > 255 ? randomrgb[i] = 255 : randomrgb[i];
            randomrgb[i]-30 < 0 ? darker.push(0) : darker.push(randomrgb[i]-30);
            randomrgb[i]-50 < 0 ? darkest.push(0) : darkest.push(randomrgb[i]-50);
        }
        bgformatted = `rgb(${randomrgb[0]},${randomrgb[1]},${randomrgb[2]})`;
        shadow = `0 0 10px 10000px rgb(${darker[0]},${darker[1]},${darker[2]})`;
        cinput = `rgb(${darkest[0]},${darkest[1]},${darkest[2]})`;
        let ret = {
            bgformatted: bgformatted,
            shadow: shadow,
            cinput: cinput,
            text: text
        }
        return ret;
    }

    builder.prototype.randomizedstartinganimation = function(args) {
        //dragons be here
        args = this.getTheme(args); 
        this.chat.stop().animate({
            top: `${Math.floor(Math.random()*99)}%`,
            left: `${Math.floor(Math.random()*99)}%`,
            width: '15px',
            height: '15px',
            opacity: '1.0',
        }, 0, null, ()=> {
            this.chat.stop().animate({
                top: `${Math.floor(Math.random()*99)}%`,
                left: `${Math.floor(Math.random()*99)}%`,
                backgroundColor: args.bgformatted,
            }, 1000, null, ()=> {
                this.textarea.stop().animate({
                    backgroundColor: '#e5e5e5'
                }, 1500);
                this.chat.stop().animate({ 
                    top: '0px',
                    left: '0px',
                    height: '50%',
                    width: '50%',
                }, 1500, null, ()=> {
                    this.chat.stop().animate({
                        boxShadow: `1 1 1000px 100px 'silver'`
                    },400, null, ()=>{
                        this.chat.stop().animate({
                            boxShadow: args.shadow
                        },3000);
                        this.msgs.stop().animate({
                            color: args.text,
                            backgroundColor: args.bgformatted
                            //doesn't work shamefully
                            //textShadow: args.shadow
                        },2000);
                        this.istyping.stop().animate({
                            color: args.text,
                            backgroundColor: args.bgformatted
                        },2000);
                    });
                    this.textarea.stop().animate({
                        backgroundColor: 'white'
                    },150, null, ()=>{
                        this.textarea.stop().animate({
                            backgroundColor: args.cinput,
                            color: args.text
                        }, 1500);
                    });
                    this.config.stop().animate({
                        backgroundColor: args.bgformatted,
                        color: args.text
                    });
                    this.onlineusers.stop().animate({
                            opacity: 1
                    }, 1500);
                });
            });
        });
    }

//a glorified animation
    $(document).ready(()=> {
        chat.randomizedstartinganimation(0);
        //glowing red text for banner and online users
        setInterval(()=> {
            $('.redshadow').animate({
                opacity: 1.0
            }, 500);
            $('.redshadow').animate({
                opacity: .5
            });
        }, 1000);
    });

//net
    //data expects data.chatmessages[].properties
    socket.on('addToChat', (data) => {
        if (!data.chatmessages[0].curtab)
            data.chatmessages[0].curtab = 'Main';
        let boolers = null;
        for(let i=0; i<chat.cgroup.tabs().children().length; i++){
            let temp = chat.cgroup.tabs().children()[i].innerText;
            temp = temp.slice(0, -1);
            if (temp == data.chatmessages[0].curtab)
                boolers = true;
        }
        if(!boolers){
            chat.newtab({curtab: data.chatmessages[0].curtab});
        }
        let shouldscroll = chat.msgs.scrollTop() >= (chat.msgs[0].scrollHeight - document.getElementsByClassName('msgs')[0].offsetHeight);
        let renderobj = new builder.RenderingObject(chat);
        for (let i=0; i<data.chatmessages.length; i++){
            //evil dragons be here
            renderobj[data.chatmessages[i].action](data.chatmessages[i]);
        }

        chat.prevmsgs[chat.curtab] = chat.msgs[0].innerHTML;

        if (shouldscroll)
            chat.scrollBottom();
    });

    //data expects array
    socket.on('updateUsers', (data) => {
        chat.onlineusers.empty();
        chat.onlineusers.append(`<div class='redshadow'>Online Users: &nbsp</div>`);
        for (let i=0; i<data.length; i++){
            if (isNaN(data[i]))
                data[i] = data[i].replace(/\n/g, '<br>');
            chat.onlineusers.append(`<div class='user' style='color:${data[i].color}; cursor: pointer'>${data[i]}</div>`);
        }
        $('.user').on('click', function() {
            chat.newtab({ 
                curtab: $(this)[0].textContent, 
                id: $(this)[0].textContent 
            });
        });
    });

    //data expects string
    socket.on('changeInputFontColor', (data) => {
        chat.textarea.css('color', data);
    });

    //data expects array
    socket.on('ischattinglist', (data) =>{
        let ret = '';
        if (data.length > 4){
            ret = 'Many people are typing...'
        } else if (data.length < 5 && data.length > 1){
            for(let i=0; i<data.length; i++){
                ret = ret + data[i] + ' and ';
            }
            ret = ret.substring(0, ret.length - 4);
            ret += 'are typing...'
        } else if (data.length == 1){
            ret = data[0] + ' is typing...'
        } else {
            ret = ' ';
        }
        chat.istyping.html(ret);
    });

    //data expects string
    socket.on('changeTheme', (data) => {     
        if (data == 'off'){
            chat.chat.stop().animate({
                boxShadow: `0 0 10px 1000px rgb(255,255,255)`,
                backgroundColor: 'white',
            });
            chat.msgs.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            });
            chat.textarea.stop().animate({
                color: 'white',
                backgroundColor: 'black'
            });
            chat.inputcontainer.stop().animate({
                color: 'white',
                backgroundColor: 'black'
            });
            chat.config.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            });
            chat.istyping.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            });
        } else {
            let args = chat.getTheme(data); 
            chat.randomizedstartinganimation(data);
        }
    });

    
    builder.RenderingObject = function(self) {
        this.renderText = (args) => {
            let div = `<div style='background-color:${args.bgcolor}; text-shadow: ${args.textshadow};'>${args.date}<b> ${args.name} </b><span style='color:${args.color};'>${args.msg}</span></div>`;
            self.msgs.append(div);
        },
        this.renderImage = (args) => {
            let img = `<a href='${args.msg}' target='_blank'><img class='imgs' src='${args.msg}' target='_blank' style='width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;'></img></a>`;
            let link = `<a href='${args.msg}' target='_blank'>${args.msg}</a>`;
            let div = $(`<div style='color:${args.color};'>${args.date}<b> ${args.name} </b>${link}<br>${img}</div>`);
            div.appendTo(self.msgs);
            self.imagetoggle ? $('.imgs').show() : $('.imgs').hide();
            //lolfun $('.imgs').draggable({containment: $('.msgs')});
        }
        this.renderStaticImage = (args) => {
            let img = `<img class='imgs' src='data:image/png;base64,${args.image}' style='width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;'></img>`;
            let div = `<div style ='color:${args.color};'>${args.date}<b> ${args.name} </b>${img} </div>`
            self.msgs.append(div);
            self.imagetoggle ? $('.imgs').show() : $('.imgs').hide();
        }
        this.renderCodeBlock = (args) => {
            let div = `<div style='color:${args.color};'>${args.date}<b> ${args.name} CODEBLOCK:</b> 
                      </div><pre style='white-space: pre-wrap;'><code class='code' style='border-radius: 10px;'>${args.msg.replace(/\n/g, '<br>')} </code></pre>`;
            self.msgs.append(div);
            $('.code').each(function(i, block) {
              hljs.highlightBlock(block);
            });
        }
        this.renderVideo = (args) => {
            let url = `https://www.youtube.com/embed/${args.msg}`;
            let link = `<a href='${url}'>${url}</a>`;
            let iframe = `<iframe class='iframe' style='height: 300px; width: 500px' src='//www.youtube.com/embed/${args.msg}' allowfullscreen></iframe>`; 
            let div = `<div style='color:${args.color};'>${args.date}<b> ${args.name} </b>${link}<br>${iframe}</div>`; 
            self.msgs.append(div);
            self.videotoggle ? $('.iframe').show() : $('.iframe').hide();
        }
    };
</script>