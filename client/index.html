<head>
<style>
.chat{
    position:absolute !important;
    width: 50%;
    height: 50%;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    margin-left: 4px;
    box-shadow: 10px 10px 5px #888888;
}

.chat .msgs{
    overflow-y:scroll;
    width:100%;
    height:90%;
}
#chatinput{
    resize: vertical;
    width: 100%;
    height: 10%;
    bottom: 0px;
    font-family: 'Lucida Console';
    font-size: 14px;
    margin-left: 4px;
    position: absolute !important;
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:9999;
}
.onlineusers{
	top: 0px;
    right: 17px;
    position: absolute !important;
    background-color: white;
    box-shadow: 10px 10px 5px #888888;
}
</style>
</head>
<body>
	<div id="chat" class="chat"">
	    <div class="msgs">
	        <div><b>Welcome to the proper lunch chat channel.</b></br></div>
	        <div>github for this app: <a href ="https://github.com/simon-kyger/chat" target="_blank">https://github.com/simon-kyger/chat</a></br></div>
	        <div><i>Command List:</i></br></div>
	        <div>&nbsp &nbsp <b>/name</b> <i>name</i>  :: gives you a name for current session. 20 char limit</br></div>
	        <div>&nbsp &nbsp <b>/color</b> <i>color</i>  :: changes color of your socket msgs</br></div>
	        <div>&nbsp &nbsp <b>/theme</b> dark  :: changes theme to dark (only one atm)</br></div>
	        <div>&nbsp &nbsp <b>/gif</b> <i>searchterm</i>  :: searches giphy for a gif based upon searchterm</br></div>
	    </div>
	    <input id="chatinput" class="chatinput" placeholder="Chat here!" autofocus="autofocus"></input>
	    <div id="chatresizer" class="resizer ui-resizable-handl ui-resizable-ne"></div>
		<div id="onlineusers" class="onlineusers"></div>
	</div>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
	function b64(e){var t="";var n=new Uint8Array(e);var r=n.byteLength;for(var i=0;i<r;i++){t+=String.fromCharCode(n[i])}return window.btoa(t)}

    let socket = io();
    let chat = $('.chat');
    let onlineusers = $('.onlineusers');
    chat.posts = [];
    chat.position = 0;
    chat.printer = $('.msgs', chat);
    chat.chatinput = $('.chatinput', chat);
    
//events
    chat.resizable({
        handles: {
            'ne': '#chatresizer'
        }
    });
    chat.draggable({
        containment: "body"
    });
    chat.scrollBottom = function() {
        chat.printer.stop().animate({ 
        	scrollTop: chat.printer[0].scrollHeight
        }, 1000); // SET SCROLLER TO BOTTOM
    }
    chat.scrollBottom();
    chat.postmsg = function(e) {
        //down
        if (e.which == 40){
        	chat.position--;
    		if (chat.position < 0)
    			chat.position = -1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        //up
        if (e.which == 38){
        	chat.position++;
        	if (chat.position > chat.posts.length)
    			chat.position = chat.posts.length-1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }

        //enter
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            var msg = chat.chatinput.val(); 
            
            if ($.trim(msg)) {
                socket.emit('chatMsg', msg);
                chat.posts.push(msg);
                chat.position = chat.posts.length;
                chat.chatinput[0].value = ''; // CLEAR TEXTAREA
            }
        }
    }
    chat.chatinput.keyup(chat.postmsg);

//net
    socket.on('addToChat', function (data) {
    	var shouldscroll = chat.printer.scrollTop() >= (chat.printer[0].scrollHeight - document.getElementsByClassName('msgs')[0].offsetHeight);
        var renderobj = new RenderingObject();
        for (let i=0; i<data.chatmessages.length; i++){
        	try{
        		renderobj[data.chatmessages[i].action](data.chatmessages[i]);
        	}catch(err){
        		console.log(err);
        	}
        }
        if (shouldscroll)
        	chat.scrollBottom();
    });

    socket.on('updateUsers', function (data){
    	onlineusers.empty();
    	onlineusers.append('<div>Online Users: &nbsp</div>');
    	for (var i=0; i<data.length; i++){
			if (isNaN(data[i]))
				data[i] = data[i].replace(/\n/g, '<br>');
			onlineusers.append(`<div style="color:${data[i].color}">${data[i]}</div>`);
    	}
    });

    socket.on('changeInputFontColor', function (data){
    	chat.chatinput.css("color", data);
    });

    socket.on('changeTheme', function (data){
    	data = data.trim();
    	if (data == 'dark'){
			$('body').css("background-color", "rgb(70,70,70)");
			chat.chatinput.css("background-color", "rgb(50,50,50)");
			onlineusers.css("background-color", "rgb(70,70,70)");
    	}
    	else{
			$(document.body).css("background-color", "rgb(255,255,255)");
			chat.chatinput.css("background-color", "rgb(255,255,255)");
			onlineusers.css("background-color", "rgb(255,255,255)");
    	}
    });

    
    var RenderingObject = function() {
	    this.renderText = function(args) {
	        let div = `<div style ="color:${args.color}">${args.date}<b> ${args.name}:</b> ${args.msg.replace(/\n/g, '<br>')} </div>`;
	        chat.printer.append(div);
	    },
	    this.renderImage = function(args) {
	    	let img = `<img src="data:image/png;base64,${args.image}" style="max-height:300px; max-width:300px;"></img>`;
	        let div = `<div style ="color:${args.color}">${args.date}<b> ${args.name}:</b> ${img} </div>`
	        chat.printer.append(div);
	    }
	};

</script>