<head>
<style>
body{
	margin: 0px;
}
.chat{
    position:absolute !important;
    width: 50%;
    height: 50%;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    box-shadow: 10px 10px 5px #888888;
}

.chat .msgs{
    overflow-y:scroll;
    width:100%;
    height:90%;
}
#chatinput{
    resize: vertical;
    width: 100%;
    height: 10%;
    bottom: 0px;
    font-family: 'Lucida Console';
    font-size: 14px;
    position: absolute !important;
    white-space: pre-wrap;
    resize: none;
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:9999;
}
.onlineusers{
	top: 0px;
    right: 17px;
    position: absolute !important;
    background-color: white;
    box-shadow: 10px 10px 5px #888888;
}
</style>
</head>
<body>
	<div id="chat" class="chat"">
	    <div class="msgs">
	        <div><b>Welcome to the proper lunch chat channel.</b></br></div>
	        <div>github for this app: <a href ="https://github.com/simon-kyger/chat" target="_blank">https://github.com/simon-kyger/chat</a></br></div>
	        <div><i>Command List:</i></br></div>
	        <div>&nbsp &nbsp <b>/name</b> <i>name</i>  :: gives you a name for current session. 20 char limit</br></div>
	        <div>&nbsp &nbsp <b>/color</b> <i>color</i>  :: changes color of your socket msgs</br></div>
	        <div>&nbsp &nbsp <b>/theme</b> dark  :: changes theme to dark (only one atm)</br></div>
	        <div>&nbsp &nbsp <b>/gif</b> <i>searchterm</i>  :: searches giphy for a gif based upon searchterm</br></div>
	    </div>
	    <textarea id="chatinput" class="chatinput" placeholder="Chat here!" autofocus="autofocus"></textarea>
	    <div id="chatresizer" class="resizer ui-resizable-handl ui-resizable-ne"></div>
		<div id="onlineusers" class="onlineusers"></div>
	</div>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>
//globals
    let socket = io();
    let chat = $('.chat');
    let onlineusers = $('.onlineusers');
    chat.posts = [];
    chat.position = 0;
    chat.printer = $('.msgs', chat);
    chat.chatinput = $('.chatinput', chat);
    
//events
    chat.resizable({
        handles: {
            'ne': '#chatresizer'
        }
    });
    chat.draggable({
        containment: "body"
    });
    chat.scrollBottom = function() {
        chat.printer.stop().animate({ 
        	scrollTop: chat.printer[0].scrollHeight
        }, 1000); // SET SCROLLER TO BOTTOM
    }
    chat.scrollBottom();
    chat.postmsg = function(e) {
        //down
        if (e.which == 40){
        	chat.position--;
    		if (chat.position < 0)
    			chat.position = -1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        //up
        if (e.which == 38){
        	chat.position++;
        	if (chat.position > chat.posts.length)
    			chat.position = chat.posts.length-1;
        	chat.chatinput[0].value = chat.posts[chat.position] || '';
        }

        //enter
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            var msg = chat.chatinput.val(); 
            if ($.trim(msg)) {
                socket.emit('chatMsg', msg);
                chat.posts.push(msg);
                chat.position = chat.posts.length;
                chat.chatinput[0].value = ''; // CLEAR TEXTAREA
            }
        }
    }
    chat.chatinput.keyup(chat.postmsg);

//net
    //data expects data.chatmessages[].properties
    socket.on('addToChat', function (data) {
    	var shouldscroll = chat.printer.scrollTop() >= (chat.printer[0].scrollHeight - document.getElementsByClassName('msgs')[0].offsetHeight);
        var renderobj = new RenderingObject();
        for (let i=0; i<data.chatmessages.length; i++){
            //evil dragons be here
        	renderobj[data.chatmessages[i].action](data.chatmessages[i]);
        }
        if (shouldscroll)
        	chat.scrollBottom();
    });

    //data expects array
    socket.on('updateUsers', function (data){
    	onlineusers.empty();
    	onlineusers.append('<div>Online Users: &nbsp</div>');
    	for (var i=0; i<data.length; i++){
			if (isNaN(data[i]))
				data[i] = data[i].replace(/\n/g, '<br>');
			onlineusers.append(`<div style="color:${data[i].color}">${data[i]}</div>`);
    	}
    });

    //data expects string
    socket.on('changeInputFontColor', function (data){
    	chat.chatinput.css("color", data);
    });

    //data expects string
    socket.on('changeTheme', function (data){
    	data = data.trim();
    	if (data == 'dark'){
			$('body').css("background-color", "rgb(70,70,70)");
			chat.chatinput.css("background-color", "rgb(50,50,50)");
			onlineusers.css("background-color", "rgb(70,70,70)");
    	}
    	else{
			$(document.body).css("background-color", "rgb(255,255,255)");
			chat.chatinput.css("background-color", "rgb(255,255,255)");
			onlineusers.css("background-color", "rgb(255,255,255)");
    	}
    });

    
    var RenderingObject = function() {
	    this.renderText = function(args) {
            let container = args.msg.split(' ');
            for (let i=0; i<container.length; i++){
                if ((container[i].substr(0, 8)) == 'https://' || (container[i].substr(0, 7)) == 'http://'){
                    let ext = container[i].substr(container[i].length-4, 3);
                    console.log(ext);
                    if (ext == 'gif' || ext == 'jpg' || ext == 'png' || ext == 'mp4' || ext == 'tif' || 'ebp'){
                        container[i] = `<a href="${container[i]}" target="_blank"><img src="${container[i]}" target="_blank" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img></a>`;
                    } else {
                        container[i] = `<a href="${container[i]}" target="_blank">${container[i]}</a>`;
                    }
                }
            }
            let msg = container.join(' ');
	        let div = `<div style="color:${args.color};">${args.date}<b> ${args.name}: </b>${msg}</div>`;
	        chat.printer.append(div);
	    },
        this.renderImage = function(args) {
            let img = `<a href="${args.link}" target="_blank"><img src="${args.link}" target="_blank" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img></a>`;
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name}: </b>${img}</div>`
            chat.printer.append(div);
        }
	    this.renderStaticImage = function(args) {
	    	let img = `<img src="data:image/png;base64,${args.image}" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img>`;
	        let div = `<div style ="color:${args.color};">${args.date}<b> ${args.name}: </b>${img} </div>`
	        chat.printer.append(div);
	    }
        this.renderCodeBlock = function(args){
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name}: CODEBLOCK:</b> 
                      </div><pre style="white-space: pre-wrap;"><code class="code" style="border-radius: 10px;">${args.msg.replace(/\n/g, '<br>')} </code></pre>`;
            chat.printer.append(div);
            $('.code').each(function(i, block) {
              hljs.highlightBlock(block);
            });
        }
	};

</script>