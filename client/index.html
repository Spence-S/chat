<head>
<style>
body{
    margin: 0px;
}
.chat{
    position:absolute !important;
    width: 0%;
    height: 0%;
    opacity: 0;
    overflow:hidden;
    font-family: 'Lucida Console';
    font-size: 14px;
    box-shadow: 0px 0px 1px 1px #888888;
}
.chat .msgs{
    overflow-y:scroll;
    width:100%;
    height:85%;
}
.inputcontainer{
    width: 100%;
    height: 15%;
    font-family: 'Lucida Console';
    font-size: 14px;
    position: absolute !important;
    white-space: pre-wrap;
    resize: none;
    color: white;
}
.istyping{
    position:absolute;
    top: 0%;
    //width: -webkit-calc(100% - 15px);
    width: 100%;
    height: 30%;
    line-height: 1.3;
}
.inputcontainer .chatinput{
    position: absolute;
    top: 30%;
    width: 100%;
    height: 70%;
    left: 0;
    resize: none;
    overflow: hidden;
    border: 1px solid black;
}
.inputcontainer .cfg{
    z-index: 999;
    position: absolute;
    right: 2%;
    font-size: 32px;
    bottom: 15%;
    cursor: pointer;
    -webkit-text-size-adjust:none;
}
.config{
    position: absolute !important;
    bottom: 0px;
    right: 0px;
    font-size: 14px;
    width: 0%;
    height: 0%;
    opacity: 0;
    border-color: rgb(0, 0, 0);
    font-family: monospace;
    border-style: solid;
    border-width: 2px;
    background-color: rgb(200, 200, 200);
}
.resizer {
    width: 15px;
    height: 15px;
    background-color: #333333;
    border: 1px solid #000000;
    top: 0px;
    right: 0px;
    position: absolute !important;
    z-index:9999;
    cursor: nesw-resize;
}
.onlineusers{
    top: 0px;
    right: 17px;
    position: absolute !important;
    z-index: 9999;
    opacity: 0;
    border-left: 1px solid;
    border-bottom: 1px solid;
    border-color: black; 
    padding-left: 1px;
    padding-bottom: 1px;
}
.redshadow{
    text-shadow: 2px 2px 8px #FF0000;
    font-weight: bold;
}
</style>
</head>
<body>
    <div id="chat" class="chat"">
        <div class="msgs">
            <div class="redshadow">Welcome to the proper lunch chat channel!</br></div>
            <div>&nbsp; &nbsp; github --> <a href ="https://github.com/simon-kyger/chat" target="_blank">https://github.com/simon-kyger/chat</a></br></div>
            <div>&nbsp; &nbsp; <i>Commandlist: /? or /help</i></br></div>
        </div>
        <div id="inputcontainer" class="inputcontainer">
            <div class="istyping"> </div>
            <textarea id="chatinput" class="chatinput" placeholder="Chat here! or /? for a list of commands." autofocus="autofocus"></textarea>
            <div id="cfg" class="cfg">&#x2699;</div>
        </div>
        <div id="chatresizer" class="resizer ui-resizable-handl ui-resizable-ne"></div>
        <div id="onlineusers" class="onlineusers"></div>   
        <div id="config" class="config">
            <input id="videotoggle" class="videotoggle" type="checkbox">Hide Videos<br>
            <input id="imagetoggle" class="imagetoggle" type="checkbox">Hide Images
        </div>
    </div>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="//cdn.jsdelivr.net/jquery.shadow-animation/1/mainfile"></script>
<script>
//globals
    let socket = io();
    let chat = $('.chat');
    let onlineusers = $('.onlineusers');
    chat.posts = [];
    chat.position = 0;
    chat.printer = $('.msgs', chat);
    chat.chatinput = $('.chatinput', chat);
    chat.cfg = $('.cfg');
    chat.config = $('.config');
    chat.cfg.videostoggle = $('.videotoggle');
    chat.cfg.imagestoggle = $('.imagetoggle');
    chat.istyping = $('.istyping');
    
//events
    chat.resizable({
        handles: {
            'ne': '#chatresizer'
        }
    });
    chat.draggable({
        containment: "body"
    });
    chat.scrollBottom = () => {
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 1000); // SET SCROLLER TO BOTTOM
    }
    chat.scrollBottom();
    chat.postmsg = (e) => {
        //down
        if (e.which == 40){
            chat.position--;
            if (chat.position < 0)
                chat.position = -1;
            chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        //up
        if (e.which == 38){
            chat.position++;
            if (chat.position > chat.posts.length)
                chat.position = chat.posts.length-1;
            chat.chatinput[0].value = chat.posts[chat.position] || '';
        }
        if (e.which == 13 && !e.shiftKey)
            e.preventDefault();
        //enter
        if (e.which == 13 && !e.shiftKey && chat.chatinput.val().trim().length>0) {
            e.preventDefault();
            let msg = chat.chatinput.val().trim(); 
            socket.emit('chatMsg', msg);
            chat.posts.push(msg);
            chat.position = chat.posts.length;
            chat.chatinput[0].value = ''; // CLEAR TEXTAREA
            chat.scrollBottom();
            socket.chatting = false;
        }
        //any other key
        if (chat.chatinput.val().length){
            socket.emit('istyping', 1);
        } else{
            socket.emit('istyping', 0);
        }
    }
    chat.chatinput.on("change keyup keydown input paste", chat.postmsg);


    chat.cfg.expanded = true;
    chat.cfg.expand = () => {
        if (chat.cfg.expanded){
            chat.config.animate({
                width: "0%",
                height: "0%",
                opacity: 0,
                fontSize: "0",
                borderWidth: "20px"
            }, 500 );
            chat.cfg.expanded = false;
        } else {
            chat.config.animate({
                width: "20%",
                height: "30%",
                opacity: 0.8,
                fontSize: "14",
                borderWidth: "2px"
            }, 500 );
            chat.cfg.expanded = true;
        }
    }
    chat.cfg.click(chat.cfg.expand);
    chat.cfg.click();

    chat.cfg.videostoggle.on('change', ()=> {
        chat.cfg.videostoggle ? $('.iframe').hide() : $('.iframe').show();
        chat.cfg.videostoggle = !chat.cfg.videostoggle;
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 0); 
    });
    chat.cfg.imagestoggle.on('change', ()=> {
        chat.cfg.imagestoggle ? $('.imgs').hide() : $('.imgs').show();
        chat.cfg.imagestoggle = !chat.cfg.imagestoggle;
        chat.printer.stop().animate({ 
            scrollTop: chat.printer[0].scrollHeight
        }, 0); 
    });

    chat.getTheme = (args)=> {
        let bgformatted;
        let shadow;
        let text;
        let cinput;
        if (args > 0)
            text = 'black'
        else
            text = 'white';

        let randomrgb = [((Math.floor(Math.random()*150)+55)+args), ((Math.floor(Math.random()*150)+55)+args), ((Math.floor(Math.random()*150)+55)+args)];
        let darker = [];
        let darkest = [];
        for(let i=0; i<randomrgb.length; i++){
            randomrgb[i] < 0 ? randomrgb[i] = 0 : randomrgb[i];
            randomrgb[i] > 255 ? randomrgb[i] = 255 : randomrgb[i];
            randomrgb[i]-30 < 0 ? darker.push(0) : darker.push(randomrgb[i]-30);
            randomrgb[i]-50 < 0 ? darkest.push(0) : darkest.push(randomrgb[i]-50);
        }
        bgformatted = `rgb(${randomrgb[0]},${randomrgb[1]},${randomrgb[2]})`;
        shadow = `0 0 10px 1000px rgb(${darker[0]},${darker[1]},${darker[2]})`;
        cinput = `rgb(${darkest[0]},${darkest[1]},${darkest[2]})`;
        let ret = {
            bgformatted: bgformatted,
            shadow: shadow,
            cinput: cinput,
            text: text
        }
        return ret;
    }

    chat.randomizedstartinganimation = (args)=> {
        //dragons be here
        args = chat.getTheme(args); 
        chat.stop().animate({
            top: `${Math.floor(Math.random()*99)}%`,
            left: `${Math.floor(Math.random()*99)}%`,
            width: '15px',
            height: '15px',
            opacity: '1.0',
        }, 0, null, ()=> {
            chat.stop().animate({
                top: `${Math.floor(Math.random()*99)}%`,
                left: `${Math.floor(Math.random()*99)}%`,
                backgroundColor: args.bgformatted,
            }, 1000, null, ()=> {
                chat.chatinput.stop().animate({
                    backgroundColor: '#e5e5e5'
                }, 1500);
                chat.stop().animate({ 
                    top: '0px',
                    left: '0px',
                    height: '50%',
                    width: '50%',
                }, 1500, null, ()=> {
                    chat.stop().animate({
                        boxShadow: `1 1 1000px 100px 'silver'`
                    },400, null, ()=>{
                        chat.stop().animate({
                            boxShadow: args.shadow
                        },3000);
                        chat.printer.stop().animate({
                            color: args.text,
                            backgroundColor: args.bgformatted
                            //doesn't work shamefully
                            //textShadow: args.shadow
                        },2000);
                        chat.istyping.stop().animate({
                            color: args.text,
                            backgroundColor: args.bgformatted
                        },2000);
                    });
                    chat.chatinput.stop().animate({
                        backgroundColor: 'white'
                    },150, null, ()=>{
                        chat.chatinput.stop().animate({
                            backgroundColor: args.cinput,
                            color: args.text
                        }, 1500);
                    });
                    chat.config.stop().animate({
                        backgroundColor: args.bgformatted,
                        color: args.text
                    });
                    onlineusers.stop().animate({
                            opacity: 1
                    }, 1500);
                });
            });
        });
    }

//a glorified animation
    $(document).ready(()=> {
        chat.randomizedstartinganimation(0);
        //glowing red text for banner and online users
        setInterval(()=> {
            $('.redshadow').animate({
                opacity: 1.0
            }, 500);
            $('.redshadow').animate({
                opacity: .5
            });
        }, 1000);
    });

//net
    //data expects data.chatmessages[].properties
    socket.on('addToChat', (data) => {
        let shouldscroll = chat.printer.scrollTop() >= (chat.printer[0].scrollHeight - document.getElementsByClassName('msgs')[0].offsetHeight);
        let renderobj = new chat.RenderingObject();
        for (let i=0; i<data.chatmessages.length; i++){
            //evil dragons be here
            renderobj[data.chatmessages[i].action](data.chatmessages[i]);
        }
        if (shouldscroll)
            chat.scrollBottom();
    });

    //data expects array
    socket.on('updateUsers', (data) => {
        onlineusers.empty();
        onlineusers.append('<div class="redshadow">Online Users: &nbsp</div>');
        for (let i=0; i<data.length; i++){
            if (isNaN(data[i]))
                data[i] = data[i].replace(/\n/g, '<br>');
            onlineusers.append(`<div style="color:${data[i].color}">${data[i]}</div>`);
        }
    });

    //data expects string
    socket.on('changeInputFontColor', (data) => {
        chat.chatinput.css("color", data);
    });

    //data expects array
    socket.on('ischattinglist', (data) =>{
        let ret = '';
        if (data.length > 4){
            ret = 'Many people are typing...'
        } else if (data.length < 5 && data.length > 1){
            for(let i=0; i<data.length; i++){
                ret = ret + data[i] + ' and ';
            }
            ret = ret.substring(0, ret.length - 4);
            ret += 'are typing...'
        } else if (data.length == 1){
            ret = data[0] + ' is typing...'
        } else {
            ret = ' ';
        }
        chat.istyping.html(ret);
    });

    //data expects string
    socket.on('changeTheme', (data) => {     
        if (data == 'off'){
            chat.stop().animate({
                boxShadow: `0 0 10px 1000px rgb(255,255,255)`,
                backgroundColor: 'white',
            },200);
            chat.printer.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            },200);
            chat.chatinput.stop().animate({
                color: 'white',
                backgroundColor: 'black'
            },200);
            chat.config.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            },200);
            chat.istyping.stop().animate({
                color: 'black',
                backgroundColor: 'white'
            });
        } else {
            let args = chat.getTheme(data); 
            chat.randomizedstartinganimation(data);
        }
    });

    
    chat.RenderingObject = function() {
        this.renderText = (args) => {
            let div = `<div style="color:${args.color}; background-color:${args.bgcolor}; text-shadow: ${args.textshadow};">${args.date}<b> ${args.name} </b>${args.msg}</div>`;
            chat.printer.append(div);
        },
        this.renderImage = (args) => {
            let img = `<a href="${args.msg}" target="_blank"><img class="imgs" src="${args.msg}" target="_blank" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img></a>`;
            let link = `<a href="${args.msg}" target="_blank">${args.msg}</a>`;
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} </b>${link}<br>${img}</div>`
            chat.printer.append(div);
            chat.cfg.imagestoggle ? $('.imgs').show() : $('.imgs').hide();
            //lolfun $('.imgs').draggable({containment: $('.msgs')});
        }
        this.renderStaticImage = (args) => {
            let img = `<img class="imgs" src="data:image/png;base64,${args.image}" style="width: auto; max-height: 300px; max-width: 300px;border-radius: 10px;"></img>`;
            let div = `<div style ="color:${args.color};">${args.date}<b> ${args.name} </b>${img} </div>`
            chat.printer.append(div);
            chat.cfg.imagestoggle ? $('.imgs').show() : $('.imgs').hide();
        }
        this.renderCodeBlock = (args) => {
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} CODEBLOCK:</b> 
                      </div><pre style="white-space: pre-wrap;"><code class="code" style="border-radius: 10px;">${args.msg.replace(/\n/g, '<br>')} </code></pre>`;
            chat.printer.append(div);
            $('.code').each(function(i, block) {
              hljs.highlightBlock(block);
            });
        }
        this.renderVideo = (args) => {
            let url = `https://www.youtube.com/embed/${args.msg}`;
            let link = `<a href="${url}">${url}</a>`;
            let iframe = `<iframe class="iframe" style="height: 300px; width: 500px" src="//www.youtube.com/embed/${args.msg}" allowfullscreen></iframe>`; 
            let div = `<div style="color:${args.color};">${args.date}<b> ${args.name} </b>${link}<br>${iframe}</div>`; 
            chat.printer.append(div);
            chat.cfg.videostoggle ? $('.iframe').show() : $('.iframe').hide();
        }
    };
</script>